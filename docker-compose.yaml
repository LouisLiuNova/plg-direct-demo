services:
  # ==========================================
  # 节点 1: 转发服务 (Forwarder Node)
  # ==========================================
  forwarder-app:
    build:
      context: ./src
      dockerfile: docker/Dockerfile.forwarder
    container_name: forwarder-app
    environment:
      - APP_PROCESSOR_URL=http://processor-app:8000/receive
      - APP_TPS=20
      - TZ=Asia/Shanghai
    volumes:
      - logs-forwarder:/var/log/app # 写日志到共享卷
    depends_on:
      - processor-app
  alloy-forwarder:
    image: grafana/alloy:latest
    container_name: forwarder-alloy
    environment:
      - TZ=Asia/Shanghai
    volumes:
      # 挂载配置文件
      - ./config/alloy-config.local.alloy:/etc/alloy/config.alloy
      # 挂载日志目录 (与之前 Promtail 一样)
      - logs-forwarder:/var/log/app:ro
      # 挂载数据目录 (用于记录读取位置 positions)
      - alloy-data-forwarder:/var/lib/alloy
    command: run --server.http.listen-addr=0.0.0.0:12345 --storage.path=/var/lib/alloy /etc/alloy/config.alloy
    ports:
      - "12345:12345" # Alloy 的调试 UI 端口
    depends_on:
      - forwarder-app

  # ==========================================
  # 节点 2: 处理服务 (Processor Node)
  # ==========================================
  processor-app:
    build:
      context: ./src
      dockerfile: docker/Dockerfile.processor
    container_name: processor-app
    environment:
      - APP_LOSS_RATE=0.2
      - TZ=Asia/Shanghai
    volumes:
      - logs-processor:/var/log/app # 写日志到共享卷

  alloy-processor:
    image: grafana/alloy:latest
    container_name: processor-alloy
    environment:
      - TZ=Asia/Shanghai
    volumes:
      # 挂载配置文件
      - ./config/alloy-config.local.alloy:/etc/alloy/config.alloy
      # 挂载日志目录 (与之前 Promtail 一样)
      - logs-processor:/var/log/app:ro
      # 挂载数据目录 (用于记录读取位置 positions)
      - alloy-data-processor:/var/lib/alloy
    command: run --server.http.listen-addr=0.0.0.0:12345 --storage.path=/var/lib/alloy /etc/alloy/config.alloy
    ports:
      - "12346:12345" # Alloy 的调试 UI 端口
    depends_on:
      - processor-app
  # ==========================================
  # 节点 3: 监控中心 (Monitor Node)
  # ==========================================
  loki:
    image: grafana/loki:3.6.0
    user: root # Use root to avoid permission issues. See: https://github.com/grafana/loki/issues/5513
    container_name: loki
    ports: [ "3100:3100" ]
    environment:
      - TZ=Asia/Shanghai
    command: -config.file=/etc/loki/loki-config.yaml
    volumes:
      # 挂载自定义配置文件到容器默认路径
      - ./config/loki-config.local.yaml:/etc/loki/loki-config.yaml
      - loki-data:/loki # 命名卷挂载到/loki

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports: [ "3700:3000" ]
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - TZ=Asia/Shanghai
    depends_on:
      - loki
    volumes:
      - grafana_data:/var/lib/grafana
      - ./provisioning/datasources:/etc/grafana/provisioning/datasources
      - ./dashboards/:/etc/grafana/provisioning/dashboards/
  watcher:
    build:
      context: ./src
      dockerfile: docker/Dockerfile.watcher
    container_name: watcher
    environment:
      - LOKI_URL=http://loki:3100
      - TZ=Asia/Shanghai
      - CHECK_INTERVAL_SECONDS=30 # 每 x sec运行一次审计
      - WINDOW_OFFSET_SECONDS=60 # 审计窗口向前偏移 x sec
      - WINDOW_EXTEND_SECONDS=10 # 审计窗口扩展 x sec
      - DB_HOST=mysql # 和MYSQL服务名称一致
      - DB_PORT=3306
      - DB_ROOT_PASSWORD=root # 和MYSQL_ROOT_PASSWORD一致
      - DB_USER=user # 和MYSQL_USER一致
      - DB_PASSWORD=test123456
      - DB_NAME=watcher_db
    volumes:
      - ./reports:/data/reports
    depends_on:
      loki:
        condition: service_started
      alloy-forwarder:
        condition: service_started
      alloy-processor:
        condition: service_started
      mysql:
        condition: service_healthy  # 仅等待mysql健康检查通过
    ports:
      - "8000:8000"
    restart: on-failure
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    environment:
      - TZ=Asia/Shanghai
    volumes:
      # 将宿主机的配置文件挂载到容器内部
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090" # Prometheus 的 Web UI 端口
    depends_on:
      - watcher
      - grafana
  # 用于模拟TiDB的mysql服务
  mysql:
    image: mysql:9.6.0
    # 容器名称（自定义，方便识别容器）
    container_name: mysql
    ports:
      - "3306:3306"
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: test_db
      MYSQL_USER: user # Use normal user for connection
      MYSQL_PASSWORD: test123456
      MYSQL_INITDB_ARGS: "--character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci"
      MYSQL_BIND_ADDRESS: 0.0.0.0
    volumes:
      - mysql_data:/var/lib/mysql
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-uuser", "-ptest123456"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s
volumes:
  logs-forwarder: # 节点1的磁盘
  logs-processor: # 节点2的磁盘
  grafana_data: # 监控数据持久化
  loki-data: # Loki 数据持久化
  alloy-data-processor:
  alloy-data-forwarder:
  mysql_data: # MySQL 数据持久化
